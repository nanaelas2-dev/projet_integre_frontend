<div class="card">
  <!-- HEADER: Author & Date -->
  <div class="card-header">
    <div class="meta-left">
      <!-- Avatar Circle (Initials) -->
      <div class="avatar">{{ getInitials() }}</div>
      <div class="info">
        <!-- Author Name -->
        <span class="author-name">
          {{ publication.utilisatrice.prenom }} {{ publication.utilisatrice.nom | uppercase }}
        </span>
        <span class="pub-date">{{ publication.datePublication | date:'dd MMM yyyy, HH:mm' }}</span>
      </div>
    </div>

    <span class="category-badge">{{ publication.categorie }}</span>
  </div>

  <!-- BODY -->
  <div class="card-body">
    @if (!isEditing()) {
    <!-- VIEW MODE -->
    <p class="description">{{ publication.description }}</p>

    @if (publication.pieceJointe) {
    <div class="attachment-container">
      @switch (publication.type_piece_jointe) {

      <!-- CASE 1: IMAGE -->
      @case (Type.IMAGE) {
      <img
        [src]="publication.pieceJointe | safeUrl:'IMAGE'"
        class="media-image"
        alt="Publication Image"
      />
      }

      <!-- CASE 2: YOUTUBE VIDEO -->
      @case (Type.VIDEO_LINK) {
      <div class="video-wrapper">
        <iframe
          [src]="publication.pieceJointe | safeUrl:'VIDEO_LINK'"
          frameborder="0"
          allowfullscreen
        >
        </iframe>
      </div>
      }

      <!-- CASE 3: PDF -->
      @case (Type.PDF) {
      <a [href]="publication.pieceJointe | safeUrl:'PDF'" target="_blank" class="pdf-link">
        üìÑ Voir le document PDF
      </a>
      }

      <!-- CASE 4: STANDARD LINK -->
      @case (Type.TEXT_LINK) {
      <a [href]="publication.pieceJointe" target="_blank" class="text-link">
        üîó {{ publication.pieceJointe }}
      </a>
      } }
    </div>
    } } @else {
    <!-- EDIT MODE (Form) -->
    <form [formGroup]="editForm" (ngSubmit)="onSave()">
      <!-- Category -->
      <div class="form-group">
        <select formControlName="categorie" class="form-control">
          @for (cat of categories; track cat) {
          <option [value]="cat">{{ cat }}</option>
          }
        </select>
      </div>

      <!-- Description -->
      <div class="form-group">
        <textarea formControlName="description" rows="3" class="form-control"></textarea>
      </div>

      <!-- === EDIT ATTACHMENT SECTION === -->
      <div class="edit-attachment-section">
        <label>Modifier la pi√®ce jointe :</label>

        <!-- Tabs -->
        <div class="edit-tabs">
          <button
            type="button"
            [class.active]="editMode() === 'FILE'"
            (click)="setEditMode('FILE')"
          >
            üì∑ Fichier
          </button>
          <button
            type="button"
            [class.active]="editMode() === 'LINK'"
            (click)="setEditMode('LINK')"
          >
            üîó Lien
          </button>
        </div>

        <!-- FILE -->
        @if (editMode() === 'FILE') {
        <div class="file-input-wrapper">
          <input #fileInput type="file" (change)="onFileSelected($event)" style="display: none" />
          <button type="button" class="btn-secondary" (click)="fileInput.click()">
            {{ newFile() ? 'üìÅ Fichier s√©lectionn√©' : 'üìÇ Changer le fichier' }}
          </button>
          @if (newFile()) {
          <span class="file-name">{{ newFile()?.name }}</span>
          } @else {
          <span class="file-name hint"> (Laisser vide pour garder l'actuel) </span>
          }
        </div>
        }

        <!-- LINK -->
        @if (editMode() === 'LINK') {
        <input
          type="text"
          formControlName="lien"
          class="form-control"
          placeholder="Coller le lien YouTube..."
        />
        }
      </div>

      <!-- Actions -->
      <div class="edit-actions">
        <button type="button" (click)="toggleEdit()" class="btn-cancel">Annuler</button>
        <button type="submit" [disabled]="editForm.invalid" class="btn-save">Enregistrer</button>
      </div>
    </form>
    }
  </div>

  <!-- FOOTER ACTIONS -->
  <div class="card-footer">
    <!-- Comment Toggle Button -->
    <button (click)="toggleComments()" class="btn-toggle-comments">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="16"
        height="16"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
      </svg>
      {{ comments().length }} {{ comments().length === 1 ? 'commentaire' : 'commentaires' }}
    </button>

    <!-- Spacer to push edit/delete to the right -->
    <span class="spacer"></span>

    <!-- Edit/Delete (Only if owner) -->
    @if (!isEditing() && isOwner()) {
    <button (click)="toggleEdit()" class="btn-icon">Modifier</button>
    <button (click)="onDelete()" class="btn-icon delete">Supprimer</button>
    }
  </div>

  <!-- COMMENTS SECTION -->
  @if (showComments() && !isEditing()) {
  <div class="comments-section">
    <!-- Loading State -->
    @if (isLoadingComments()) {
    <p class="loading-text">Chargement des commentaires...</p>
    }

    <!-- Comments List -->
    <div class="comments-list">
      @for (comment of comments(); track comment.id) {
      <div class="comment-item">
        <div class="comment-avatar">{{ getCommentAuthorInitials(comment) }}</div>

        <div class="comment-content">
          <div class="comment-header">
            <!-- Updated to match Commentaire model (nested utilisateur) -->
            <span class="comment-author">
              {{ comment.utilisateur.prenom }} {{ comment.utilisateur.nom }}
            </span>
            <!-- Updated to match Commentaire model (createdAt) -->
            <span class="comment-date">{{ comment.createdAt | date:'dd MMM HH:mm' }}</span>
          </div>

          <p class="comment-text">{{ comment.contenu }}</p>

          <!-- Delete Comment (Only if owner of the comment) -->
          @if (isCommentOwner(comment)) {
          <button class="btn-delete-comment" (click)="deleteComment(comment.id)">‚úñ</button>
          }
        </div>
      </div>
      } @empty { @if (!isLoadingComments()) {
      <p class="no-comments">Soyez la premi√®re √† commenter !</p>
      } }
    </div>

    <!-- Add Comment Form -->
    <div class="add-comment-form">
      <input
        type="text"
        [ngModel]="newCommentText()"
        (ngModelChange)="newCommentText.set($event)"
        placeholder="Ajouter un commentaire..."
        (keyup.enter)="addComment()"
      />
      <button (click)="addComment()" [disabled]="!newCommentText().trim()">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="18"
          height="18"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      </button>
    </div>
  </div>
  }
</div>
