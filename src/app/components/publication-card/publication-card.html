<div class="card">
  <!-- HEADER: Author & Date -->
  <div class="card-header">
    <div class="meta-left">
      <!-- Avatar Circle (Initials) -->
      <div class="avatar">{{ getInitials() }}</div>
      <div class="info">
        <!-- Author Name -->
        <span class="author-name">
          {{ publication.utilisatrice.prenom }} {{ publication.utilisatrice.nom | uppercase }}
        </span>
        <span class="pub-date">{{ publication.datePublication | date:'dd MMM yyyy, HH:mm' }}</span>
      </div>
    </div>

    <span class="category-badge">{{ publication.categorie }}</span>
  </div>

  <!-- BODY -->
  <div class="card-body">
    @if (!isEditing()) {
    <p class="description">{{ publication.description }}</p>

    @if (publication.pieceJointe) {
    <a [href]="publication.pieceJointe" target="_blank" class="attachment"> ðŸ“Ž PiÃ¨ce jointe </a>
    } } @else {
    <!-- EDIT FORM -->
    <form [formGroup]="editForm" (ngSubmit)="onSave()">
      <div class="form-group">
        <select formControlName="categorie">
          @for (cat of categories; track cat) {
          <option [value]="cat">{{ cat }}</option>
          }
        </select>
      </div>

      <div class="form-group">
        <textarea formControlName="description" rows="4"></textarea>
      </div>

      <div class="form-group">
        <input type="text" formControlName="pieceJointe" placeholder="Lien piÃ¨ce jointe" />
      </div>

      <div class="edit-actions">
        <button type="button" (click)="toggleEdit()" class="btn-cancel">Annuler</button>
        <button type="submit" class="btn-save">Sauvegarder</button>
      </div>
    </form>
    }
  </div>

  <div class="card-footer">
    <!-- Comment Toggle Button -->
    <button (click)="toggleComments()" class="btn-icon">ðŸ’¬ Commentaires</button>

    <!-- Spacer to push edit/delete to the right -->
    <span class="spacer"></span>

    <!-- Edit/Delete (Only if owner) -->
    @if (!isEditing() && isOwner()) {
    <button (click)="toggleEdit()" class="btn-icon">Modifier</button>
    <button (click)="onDelete()" class="btn-icon delete">Supprimer</button>
    }
  </div>

  @if (showComments()) {
  <div class="comments-section">
    <!-- Add Comment Form -->
    <!-- [ngModel]: If you change the signal in code (like clearing it), the input clears. -->
    <!--(ngModelChange): If you type in the box, the signal updates. -->
    <!--(keyup.enter): Allows submitting without clicking the "Envoyer" button with enter key.-->
    <div class="add-comment">
      <input
        type="text"
        placeholder="Ã‰crire un commentaire..."
        [ngModel]="newCommentText()"
        (ngModelChange)="newCommentText.set($event)"
        (keyup.enter)="addComment()"
      />
      <button [disabled]="!newCommentText().trim()" (click)="addComment()">Envoyer</button>
    </div>

    <!-- Loading State -->
    @if (isLoadingComments()) {
    <p class="loading-text">Chargement des commentaires...</p>
    }

    <!-- Comments List -->
    <div class="comments-list">
      @for (comment of comments(); track comment.id) {
      <div class="comment-item">
        <div class="comment-header">
          <span class="comment-author">
            {{ comment.utilisateur.prenom }} {{ comment.utilisateur.nom }}
          </span>
          <span class="comment-date">{{ comment.createdAt | date:'dd/MM HH:mm' }}</span>
        </div>

        <div class="comment-body">
          <p>{{ comment.contenu }}</p>

          <!-- Delete Comment (Only if owner of the comment) -->
          @if (isCommentOwner(comment)) {
          <button class="btn-delete-comment" (click)="deleteComment(comment.id)">âœ–</button>
          }
        </div>
      </div>
      } @empty { @if (!isLoadingComments()) {
      <p class="no-comments">Soyez la premiÃ¨re Ã  commenter !</p>
      } }
    </div>
  </div>
  }
</div>
