<!-- Floating Chat Button -->
<button class="chat-toggle" (click)="toggleChat()">
  üí¨
  @if (unreadCount() > 0) {
    <span class="badge">{{ unreadCount() }}</span>
  }
</button>

<!-- Chat Panel -->
@if (isOpen()) {
  <div class="chat-panel">
    <div class="chat-header">
      @if (selectedConversation() || selectedUser() || showNewChat()) {
        <button class="back-btn" (click)="backToList()">‚Üê</button>
        <span>{{ showNewChat() ? 'Nouveau message' : chatTitle }}</span>
      } @else {
        <span>Messages</span>
        <button class="new-chat-btn" (click)="openNewChat()">+</button>
      }
      <button class="close-btn" (click)="toggleChat()">√ó</button>
    </div>

    <div class="chat-body">
      @if (showNewChat()) {
        <!-- User Selection for New Chat -->
        <div class="users-list">
          @for (user of availableUsers(); track user.id) {
            <div class="conversation-item" (click)="selectUserForChat(user)">
              <div class="conv-avatar">{{ user.prenom.charAt(0) }}</div>
              <div class="conv-info">
                <div class="conv-name">{{ user.prenom }} {{ user.nom }}</div>
                <div class="conv-preview">{{ user.email }}</div>
              </div>
            </div>
          } @empty {
            <p class="empty-state">Aucun utilisateur disponible</p>
          }
        </div>
      } @else if (!selectedConversation() && !selectedUser()) {
        <!-- Conversations List -->
        <div class="conversations-list">
          @for (conv of conversations(); track conv.id) {
            <div class="conversation-item" (click)="selectConversation(conv)">
              <div class="conv-avatar">{{ conv.autreParticipanteNom.charAt(0) }}</div>
              <div class="conv-info">
                <div class="conv-name">{{ conv.autreParticipanteNom }}</div>
                <div class="conv-preview">{{ conv.dernierMessage }}</div>
              </div>
              @if (conv.nonLus > 0) {
                <span class="conv-badge">{{ conv.nonLus }}</span>
              }
            </div>
          } @empty {
            <div class="empty-state">
              <p>Aucune conversation</p>
              <button class="start-chat-btn" (click)="openNewChat()">D√©marrer une conversation</button>
            </div>
          }
        </div>
      } @else {
        <!-- Messages View -->
        <div class="messages-container">
          @for (msg of messages(); track msg.id) {
            <div class="message" [class.own]="isOwnMessage(msg.expeditricId)">
              <div class="message-content">{{ msg.contenu }}</div>
              <div class="message-time">
                {{ msg.dateEnvoi | date:'HH:mm' }}
              </div>
            </div>
          } @empty {
            <p class="empty-state">√âcrivez votre premier message!</p>
          }
        </div>
      }
    </div>

    @if (canSendMessage) {
      <div class="chat-footer">
        <input
          type="text"
          [ngModel]="newMessage()"
          (ngModelChange)="newMessage.set($event)"
          (keyup.enter)="sendMessage()"
          placeholder="√âcrire un message..."
        />
        <button class="send-btn" (click)="sendMessage()">‚û§</button>
      </div>
    }
  </div>
}
